<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>状态量管理（同步版）</title>
<style>
  :root{--bg:#0f1720;--card:#ffffff;--accent:#2b6cb0;--danger:#e53e3e}
  body{font-family:"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#f7fafc,#edf2f7);color:#111}
  .app{max-width:720px;margin:18px auto;padding:12px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:700}
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  .row:last-child{border-bottom:0}
  .btn{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.small{padding:6px 9px;font-size:14px}
  .btn.ghost{background:#f7fafc;color:#111;border:1px solid #e2e8f0}
  .stat-label{font-size:16px;font-weight:600}
  .stat-value{font-size:16px;min-width:60px;text-align:center}
  .pager{display:flex;justify-content:center;margin-top:8px}
  .page{display:none}
  .page.active{display:block}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
  .modal .box{width:90%;max-width:420px;background:#fff;padding:14px;border-radius:10px}
  .option-row{display:flex;gap:8px;margin:8px 0}
  .plan-toggle{cursor:pointer;padding:6px 10px;border-radius:8px;border:1px dashed #cbd5e1}
  .history-list{max-height:260px;overflow:auto;padding:6px;background:#fbfdff;border-radius:6px;border:1px solid #e6eef8}
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{background:#2d3748;color:#fff;border-radius:8px;padding:8px 10px;border:0}
  .plan-input{width:100%;padding:6px;margin-bottom:6px;border-radius:5px;border:1px solid #cbd5e1;box-sizing:border-box}
  @media (max-width:420px){ .stat-label{font-size:15px} .stat-value{min-width:48px} }
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="title">状态量管理（同步版）</div>
    <div id="pageSwitchWrap">
      <button id="toPage1" class="btn small">第一页</button>
      <button id="toPage2" class="btn small btn-ghost">第二页</button>
    </div>
  </div>

  <!-- PAGE 1 -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
          <!-- 这里改成“计划”按钮 -->
          <button id="planBtn" class="btn small btn-ghost">计划</button>
        </div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div class="card" id="statsCard"></div>
    <div style="text-align:center" class="small-muted">
      提示：点击 + 或 - 进行操作，+ 操作在未制定计划时被禁止。
    </div>
  </div>

  <!-- PAGE 2 -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:700">
            胜点：<span id="scoreLabel">0</span>
          </div>
          <div class="small-muted">段位/境界：<span id="rankAndRealm">黑铁 / 凡人</span></div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div style="font-weight:700" id="highLabel">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">历史记录</div>
        <div><button id="exportBtn" class="export-btn">导出 JSON</button></div>
      </div>
      <div class="history-list" id="historyBox"></div>
    </div>
  </div>

  <!-- PAGE 3：计划制定页面 -->
  <div id="pagePlan" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">计划制定</div>
        <!-- 原先的计划状态按钮移到这里 -->
        <div id="planStatus" class="plan-toggle">计划未制定</div>
      </div>
      <div id="planList"></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="addPlan" class="btn small btn-ghost">添加一行计划</button>
        <button id="savePlan" class="btn small">保存计划</button>
      </div>
    </div>
    <div class="card">
      <button id="backFromPlan" class="btn small btn-ghost">返回状态页</button>
    </div>
  </div>
</div>

<!-- 选择值 + 理由 弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div style="font-weight:700" id="modalTitle">选择加减</div>
    <div class="option-row" id="optionRow"></div>
    <input id="reasonInput" type="text" placeholder="请输入这次加减的理由（必填）"
           style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0" />
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
      <button id="cancelModal" class="btn btn-ghost small">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<script type="module">
// Firebase 初始化
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdFS7wHsiQD1Bh_0sOvTvstt4gZvd3u6g",
  authDomain: "state-manager-561b7.firebaseapp.com",
  databaseURL: "https://state-manager-561b7-default-rtdb.firebaseio.com",
  projectId: "state-manager-561b7",
  storageBucket: "state-manager-561b7.appspot.com",
  messagingSenderId: "58381946444",
  appId: "1:58381946444:web:295079a9724fbd3093aee9",
  measurementId: "G-FQ96DM0FMX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 状态量
const stats = ["主线","综合技能","身体素质","人际关系"];
let values = {};
let logs = [];
let planMade = false;
let highest = 0;
let plans = [];

// 数据库引用
const dbRef = ref(db, "state_manager_v1");

// 监听数据变化（实时同步）
onValue(dbRef, snapshot=>{
  const data = snapshot.val();
  if(data){
    values = data.values || {};
    logs = data.logs || [];
    planMade = !!data.planMade;
    highest = data.highest || 0;
    plans = data.plans || [];
  } else {
    stats.forEach(s=>values[s]=0);
    logs = [];
    planMade = false;
    highest = 0;
    plans = [];
  }
  renderStats();
  renderHistory();
  updateTop();
  renderPlans();
});

// UI 渲染：状态量
function renderStats(){
  const card = document.getElementById("statsCard");
  card.innerHTML = "";
  stats.forEach(s=>{
    const row = document.createElement("div"); row.className="row";
    const left = document.createElement("div");
    left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
    const label = document.createElement("div"); label.className="stat-label"; label.textContent=s;
    const val = document.createElement("div"); val.className="stat-value"; val.id="val_"+s;
    val.textContent = values[s] ?? 0;
    left.appendChild(label); left.appendChild(val);

    const right = document.createElement("div");
    const addBtn = document.createElement("button"); addBtn.className="btn small"; addBtn.textContent="+";
    addBtn.onclick = ()=> openModal(s,true);
    const subBtn = document.createElement("button"); subBtn.className="btn small btn-ghost"; subBtn.textContent="-";
    subBtn.onclick = ()=> openModal(s,false);
    right.appendChild(addBtn); right.appendChild(subBtn);

    row.appendChild(left); row.appendChild(right);
    card.appendChild(row);
  });
  updateTop();
}

// UI 渲染：顶部 + 段位
function updateTop(){
  const score = Object.values(values).reduce((a,b)=>a+(Number(b)||0),0);
  const rr = rankAndRealm(score);
  document.getElementById("scoreLabel").textContent = score;
  document.getElementById("rankLabel").textContent = "段位：" + rr.rank;
  document.getElementById("rankAndRealm").textContent = rr.rank + " / " + rr.realm;
  document.getElementById("highLabel").textContent = highest;
  document.getElementById("highestPreview").textContent = highest;
  document.querySelectorAll(".stat-value").forEach(el=>{
    const id = el.id.replace("val_","");
    el.textContent = values[id] ?? 0;
  });
  const p = document.getElementById("planStatus");
  if(p){
    p.textContent = planMade ? "计划已制定" : "计划未制定";
    p.style.color = planMade ? "#111" : "var(--danger)";
  }
}

// 段位规则
function rankAndRealm(score){
  let rank, realm;
  if(score<20){rank="黑铁";realm="凡人";}
  else if(score<60){rank="青铜Ⅲ";realm="凡人";}
  else if(score<100){rank="青铜Ⅱ";realm="凡人";}
  else if(score<150){rank="青铜Ⅰ";realm="凡人";}
  else if(score<200){rank="白银Ⅲ";realm="化劲";}
  else if(score<250){rank="白银Ⅱ";realm="化劲";}
  else if(score<300){rank="白银Ⅰ";realm="化劲";}
  else if(score<400){rank="黄金Ⅲ";realm="筑基";}
  else if(score<500){rank="黄金Ⅱ";realm="筑基";}
  else if(score<600){rank="黄金Ⅰ";realm="筑基";}
  else if(score<750){rank="铂金Ⅲ";realm="炼虚";}
  else if(score<900){rank="铂金Ⅱ";realm="炼虚";}
  else if(score<1050){rank="铂金Ⅰ";realm="炼虚";}
  else {rank="王者";realm="结丹";}
  return {rank,realm};
}

// 弹窗逻辑
let modalOpenFor = null;
let modalIsAdd = true;
let chosenAmount = null;
function openModal(stat,isAdd){
  if(isAdd && !planMade){
    alert("当前未制定计划，不能加分（减分允许）。");
    return;
  }
  modalOpenFor = stat; modalIsAdd = isAdd;
  document.getElementById("modalTitle").textContent = (isAdd?"增加":"减少")+" - "+stat;
  const optionRow = document.getElementById("optionRow");
  optionRow.innerHTML = "";
  [1,3,5].forEach(n=>{
    const b = document.createElement("button");
    b.className="btn small btn-ghost";
    b.textContent = (isAdd?"+":"-")+n;
    b.onclick = (ev)=>{
      chosenAmount = n;
      Array.from(optionRow.children).forEach(bb=>bb.style.border="1px solid #e2e8f0");
      ev.target.style.border="2px solid var(--accent)";
    };
    optionRow.appendChild(b);
  });
  document.getElementById("reasonInput").value = "";
  document.getElementById("modal").style.display = "flex";
}

document.getElementById("cancelModal").onclick = ()=>{
  document.getElementById("modal").style.display = "none";
  chosenAmount = null;
};
document.getElementById("confirmModal").onclick = ()=>{
  const reason = document.getElementById("reasonInput").value.trim();
  if(!chosenAmount || reason.length===0){
    alert("请先选择数量并填写理由");
    return;
  }
  applyChange(modalOpenFor, modalIsAdd, chosenAmount, reason);
  document.getElementById("modal").style.display = "none";
  chosenAmount = null;
};

// 数据写入 Firebase
function applyChange(stat,isAdd,n,reason){
  const delta = isAdd ? n : -n;
  values[stat] = (Number(values[stat])||0) + delta;
  const ts = (new Date()).toISOString().replace("T"," ").slice(0,19);
  logs.push({time:ts,stat,delta,reason});
  const score = Object.values(values).reduce((a,b)=>a+(Number(b)||0),0);
  if(score > highest) highest = score;
  // 写入数据库，增加 plans 字段
  set(dbRef, {values, logs, planMade, highest, plans});
}

// 历史记录渲染
function renderHistory(){
  const box = document.getElementById("historyBox");
  box.innerHTML = "";
  logs.forEach(item=>{
    const d = document.createElement("div");
    d.style.padding = "6px 4px";
    d.style.borderBottom = "1px dashed #eef2ff";
    d.innerHTML = `<div style="font-weight:600">${item.time}  ${item.stat} ${item.delta>0?('+'+item.delta):item.delta}</div>
                   <div class="small-muted">理由：${escapeHtml(item.reason)}</div>`;
    box.appendChild(d);
  });
}

// 工具
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// 导出 JSON
document.getElementById("exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify({values,logs,highest,plans},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "state_history.json";
  a.click();
  URL.revokeObjectURL(url);
};

// 页面切换（第一页 / 第二页）
document.getElementById("toPage1").onclick = ()=>{
  document.getElementById("page1").classList.add("active");
  document.getElementById("page2").classList.remove("active");
  document.getElementById("pagePlan").classList.remove("active");
  document.getElementById("toPage1").classList.add("btn-ghost");
  document.getElementById("toPage2").classList.remove("btn-ghost");
};
document.getElementById("toPage2").onclick = ()=>{
  document.getElementById("page2").classList.add("active");
  document.getElementById("page1").classList.remove("active");
  document.getElementById("pagePlan").classList.remove("active");
  document.getElementById("toPage2").classList.add("btn-ghost");
  document.getElementById("toPage1").classList.remove("btn-ghost");
};

// “计划”按钮：进入计划页面
document.getElementById("planBtn").onclick = ()=>{
  document.getElementById("pagePlan").classList.add("active");
  document.getElementById("page1").classList.remove("active");
  document.getElementById("page2").classList.remove("active");
};

// 计划页面返回
document.getElementById("backFromPlan").onclick = ()=>{
  document.getElementById("pagePlan").classList.remove("active");
  document.getElementById("page1").classList.add("active");
};

// 计划状态切换（在计划页顶部）
document.getElementById("planStatus").onclick = ()=>{
  planMade = !planMade;
  set(dbRef, {values, logs, planMade, highest, plans});
  updateTop();
};

// 渲染计划列表
function renderPlans(){
  const list = document.getElementById("planList");
  list.innerHTML = "";
  if(!plans || plans.length===0){
    addPlanInput("");
    return;
  }
  plans.forEach(text=> addPlanInput(text));
}

// 添加一行计划输入
function addPlanInput(text=""){
  const list = document.getElementById("planList");
  const input = document.createElement("input");
  input.type = "text";
  input.className = "plan-input";
  input.value = text;
  list.appendChild(input);
}

// 按钮：添加计划行
document.getElementById("addPlan").onclick = ()=>{
  addPlanInput("");
};

// 按钮：保存计划
document.getElementById("savePlan").onclick = ()=>{
  const inputs = document.querySelectorAll("#planList .plan-input");
  const newPlans = [];
  inputs.forEach(inp=>{
    const t = inp.value.trim();
    if(t) newPlans.push(t);
  });
  plans = newPlans;
  set(dbRef, {values, logs, planMade, highest, plans});
  alert("计划已保存！");
};
</script>
</body>
</html>
