<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>状态量管理（同步版）</title>
<style>
  :root{--bg:#f1f5f9;--card:#ffffff;--accent:#2563eb;--danger:#dc2626;}

  body{
    font-family:"Helvetica Neue",Arial,system-ui;
    margin:0;
    background:var(--bg);
    color:#111;
  }
  .app{max-width:760px;margin:18px auto;padding:12px}

  .top{
    display:flex;align-items:center;justify-content:space-between;
    margin-bottom:12px;gap:8px;flex-wrap:wrap;
  }
  .title{font-size:20px;font-weight:700}

  .card{
    background:#fff;border-radius:10px;padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px
  }

  .row{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 0;border-bottom:1px solid #e2e8f0;
    gap:12px;flex-wrap:wrap;
  }
  .row:last-child{border-bottom:0}

  .btn{
    padding:6px 10px;border-radius:6px;border:0;
    background:var(--accent);color:#fff;font-weight:600;
    cursor:pointer;
  }
  .btn.small{padding:6px 8px;font-size:14px}
  .btn.ghost{background:#f8fafc;color:#111;border:1px solid #cbd5e1}

  .stat-label{font-size:16px;font-weight:600;min-width:80px}
  .stat-value{font-size:16px;min-width:50px;text-align:center}

  .page{display:none}
  .page.active{display:block}

  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.4);
    display:flex;align-items:center;justify-content:center;
  }

  .modal .box{
    width:90%;max-width:420px;background:#fff;padding:14px;
    border-radius:10px
  }

  .option-row{display:flex;gap:8px;margin:8px 0}
  .history-list{
    max-height:260px;overflow:auto;padding:6px;background:#fbfdff;
    border-radius:6px;border:1px solid #e6eef8
  }
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{background:#334155;color:#fff;border-radius:8px;padding:8px 10px;border:0}

  /* 计划页面样式 */
  .plan-row{
    background:#fff;padding:10px;border-radius:8px;
    box-shadow:0 3px 8px rgba(0,0,0,0.05);
    margin-bottom:10px;
  }
  .plan-row-top{
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  }
  .plan-select{
    padding:4px 6px;border-radius:6px;border:1px solid #cbd5e1;
  }
  .plan-input{
    width:100%;padding:6px;border-radius:6px;border:1px solid #cbd5e1;
    margin-top:4px;box-sizing:border-box;
  }
  .plan-done{
    padding:4px 8px;font-size:13px;border-radius:6px;border:0;
    background:#e11d48;color:#fff;cursor:pointer;
  }

  @media (max-width:420px){
    .stat-label{font-size:15px}
    .stat-value{min-width:42px}
  }
</style>
</head>
<body>

<div class="app">
  <div class="top">
    <div class="title">状态量管理（同步版）</div>
    <div id="pageSwitchWrap" style="display:flex;gap:6px;flex-wrap:wrap">
      <button id="toPage1" class="btn small">第一页</button>
      <button id="toPage2" class="btn small btn-ghost">第二页</button>
      <button id="toPlanPage" class="btn small btn-ghost">计划</button>
    </div>
  </div>

  <!-- PAGE 1（主页面） -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div class="card" id="statsCard"></div>
  </div>

  <!-- PAGE 2（历史页） -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div>
          <div style="font-size:18px;font-weight:700">胜点：<span id="scoreLabel">0</span></div>
          <div class="small-muted">段位 / 境界：<span id="rankAndRealm">黑铁 / 凡人</span></div>
        </div>

        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div style="font-weight:700" id="highLabel">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">历史记录</div>
        <button id="exportBtn" class="export-btn">导出 JSON</button>
      </div>
      <div class="history-list" id="historyBox"></div>
    </div>
  </div>

  <!-- PAGE 3（计划页面） -->
  <div id="planPage" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div style="font-weight:700;font-size:18px;">计划管理</div>
        <button id="backHome" class="btn small btn-ghost">返回</button>
      </div>
    </div>

    <div id="planContainer"></div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="addPlan" class="btn small">添加计划</button>
      <button id="savePlans" class="btn small btn-ghost">保存计划</button>
    </div>
  </div>
</div>

<!-- 选择值 + 理由 弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div style="font-weight:700" id="modalTitle">选择加减</div>
    <div class="option-row" id="optionRow"></div>
    <input id="reasonInput" type="text" placeholder="请输入这次加减的理由（必填）"
           style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0" />
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
      <button id="cancelModal" class="btn btn-ghost small">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ============ Firebase ============ */
const firebaseConfig = {
  apiKey: "AIzaSyBdFS7wHsiQD1Bh_0sOvTvstt4gZvd3u6g",
  authDomain: "state-manager-561b7.firebaseapp.com",
  databaseURL: "https://state-manager-561b7-default-rtdb.firebaseio.com",
  projectId: "state-manager-561b7",
  storageBucket: "state-manager-561b7.appspot.com",
  messagingSenderId: "58381946444",
  appId: "1:58381946444:web:295079a9724fbd3093aee9",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "state_manager_v1");

/* ============ 全局变量 ============ */
const stats = ["主线","综合技能","身体素质","人际关系"];
let values = {};
let logs = [];
let highest = 0;
let plans = [];

const planColors = {
  "主线": "#1d4ed8",
  "综合技能": "#0f766e",
  "身体素质": "#b91c1c",
  "人际关系": "#92400e"
};

/* ============ 监听数据库 ============ */
onValue(dbRef, snapshot=>{
  const data = snapshot.val();
  if(data){
    values = data.values || {};
    logs = data.logs || [];
    highest = data.highest || 0;
    plans = data.plans || [];
  }else{
    stats.forEach(s=>values[s]=0);
    logs=[];
    highest=0;
    plans=[];
  }

  renderStats();
  renderHistory();
  updateTop();
  renderPlans();
});

/* ============ 渲染状态量 ============ */
function renderStats(){
  const card = document.getElementById("statsCard");
  card.innerHTML = "";
  stats.forEach(s=>{
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.alignItems = "center";
    left.style.gap = "10px";

    const label = document.createElement("div");
    label.className = "stat-label";
    label.textContent = s;

    const val = document.createElement("div");
    val.className = "stat-value";
    val.id = "val_" + s;
    val.textContent = values[s] ?? 0;

    left.appendChild(label);
    left.appendChild(val);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "6px";

    const addBtn = document.createElement("button");
    addBtn.className = "btn small";
    addBtn.textContent = "+";
    addBtn.onclick = ()=> openModal(s,true);

    const subBtn = document.createElement("button");
    subBtn.className = "btn small btn-ghost";
    subBtn.textContent = "-";
    subBtn.onclick = ()=> openModal(s,false);

    right.appendChild(addBtn);
    right.appendChild(subBtn);

    row.appendChild(left);
    row.appendChild(right);
    card.appendChild(row);
  });
  updateTop();
}

/* ============ 段位计算 & 顶部更新 ============ */
function rankAndRealm(score){
  if(score<20)return{rank:"黑铁",realm:"凡人"};
  if(score<60)return{rank:"青铜Ⅲ",realm:"凡人"};
  if(score<100)return{rank:"青铜Ⅱ",realm:"凡人"};
  if(score<150)return{rank:"青铜Ⅰ",realm:"凡人"};
  if(score<200)return{rank:"白银Ⅲ",realm:"化劲"};
  if(score<250)return{rank:"白银Ⅱ",realm:"化劲"};
  if(score<300)return{rank:"白银Ⅰ",realm:"化劲"};
  if(score<400)return{rank:"黄金Ⅲ",realm:"筑基"};
  if(score<500)return{rank:"黄金Ⅱ",realm:"筑基"};
  if(score<600)return{rank:"黄金Ⅰ",realm:"筑基"};
  if(score<750)return{rank:"铂金Ⅲ",realm:"炼虚"};
  if(score<900)return{rank:"铂金Ⅱ",realm:"炼虚"};
  if(score<1050)return{rank:"铂金Ⅰ",realm:"炼虚"};
  return{rank:"王者",realm:"结丹"};
}

function updateTop(){
  const score = Object.values(values).reduce((a,b)=>a+(Number(b)||0),0);
  const rr = rankAndRealm(score);

  document.getElementById("scoreLabel").textContent = score;
  document.getElementById("rankLabel").textContent = "段位：" + rr.rank;
  document.getElementById("rankAndRealm").textContent = rr.rank + " / " + rr.realm;
  document.getElementById("highLabel").textContent = highest;
  document.getElementById("highestPreview").textContent = highest;

  document.querySelectorAll(".stat-value").forEach(el=>{
    const id = el.id.replace("val_","");
    el.textContent = values[id] ?? 0;
  });
}

/* ============ 弹窗加减 ============ */
let modalOpenFor = null;
let modalIsAdd = true;
let chosenAmount = null;

function openModal(stat,isAdd){
  modalOpenFor = stat;
  modalIsAdd = isAdd;

  document.getElementById("modalTitle").textContent =
    (isAdd? "增加 - ":"减少 - ") + stat;

  const optionRow = document.getElementById("optionRow");
  optionRow.innerHTML = "";

  [1,3,5].forEach(n=>{
    const b=document.createElement("button");
    b.className="btn small btn-ghost";
    b.textContent = (isAdd?"+":"-")+n;
    b.onclick = ()=>{
      chosenAmount=n;
      Array.from(optionRow.children).forEach(bb=>bb.style.border="1px solid #e2e8f0");
      b.style.border="2px solid var(--accent)";
    };
    optionRow.appendChild(b);
  });

  document.getElementById("reasonInput").value="";
  document.getElementById("modal").style.display="flex";
}

document.getElementById("cancelModal").onclick = ()=>{
  document.getElementById("modal").style.display="none";
  chosenAmount=null;
};

document.getElementById("confirmModal").onclick = ()=>{
  const reason=document.getElementById("reasonInput").value.trim();
  if(!chosenAmount || !reason){
    alert("请选择数量并填写理由");
    return;
  }
  applyChange(modalOpenFor,modalIsAdd,chosenAmount,reason);
  document.getElementById("modal").style.display="none";
  chosenAmount=null;
};

/* ============ 写入 Firebase（只改 values/logs/highest）=========== */
function applyChange(stat,isAdd,n,reason){
  const delta=isAdd? n : -n;
  values[stat]=(Number(values[stat])||0)+delta;

  const ts=new Date().toISOString().replace("T"," ").slice(0,19);
  logs.push({time:ts,stat,delta,reason});

  const score = Object.values(values).reduce((a,b)=>a+(Number(b)||0),0);
  if(score>highest) highest=score;

  update(dbRef,{ values, logs, highest });
}

/* ============ 历史记录 ============ */
function renderHistory(){
  const box=document.getElementById("historyBox");
  box.innerHTML="";
  logs.slice().reverse().forEach(item=>{
    const d=document.createElement("div");
    d.style.padding="6px 4px";d.style.borderBottom="1px dashed #eef2ff";
    d.innerHTML=`
      <div style="font-weight:600">${item.time}  ${item.stat} ${item.delta>0?('+'+item.delta):item.delta}</div>
      <div class="small-muted">理由：${item.reason}</div>`;
    box.appendChild(d);
  });
}

/* ============ 导出 JSON ============ */
document.getElementById("exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify({values,logs,highest,plans},null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="state_data.json"; a.click();
  URL.revokeObjectURL(url);
};

/* ============ 页面切换 ============ */
function showPage(id){
  ["page1","page2","planPage"].forEach(pid=>{
    document.getElementById(pid).classList.remove("active");
  });
  document.getElementById(id).classList.add("active");
}

document.getElementById("toPage1").onclick=()=>showPage("page1");
document.getElementById("toPage2").onclick=()=>showPage("page2");
document.getElementById("toPlanPage").onclick=()=>showPage("planPage");
document.getElementById("backHome").onclick=()=>showPage("page1");

/* ============ 计划页面逻辑 ============ */
const planContainer=document.getElementById("planContainer");
const addPlanBtn=document.getElementById("addPlan");
const savePlansBtn=document.getElementById("savePlans");

function renderPlans(){
  planContainer.innerHTML="";
  if(plans.length===0){
    addPlanRow({text:"",category:""});
    return;
  }
  plans.forEach(p=>addPlanRow(p));
}

function addPlanRow(planObj){
  const row=document.createElement("div");
  row.className="plan-row";

  const top=document.createElement("div");
  top.className="plan-row-top";

  const sel=document.createElement("select");
  sel.className="plan-select";

  const opt0=document.createElement("option");
  opt0.value="";opt0.textContent="选择类别";
  sel.appendChild(opt0);

  stats.forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s;opt.textContent=s;
    sel.appendChild(opt);
  });

  sel.value=planObj.category || "";

  const done=document.createElement("button");
  done.className="plan-done";
  done.textContent="已完成";
  done.onclick=()=>{
    sel.value="";
    input.value="";
    updateRowColor();
    collectPlansAndSave();
  };

  top.appendChild(sel);
  top.appendChild(done);

  const input=document.createElement("input");
  input.className="plan-input";
  input.placeholder="请输入计划内容...";
  input.value=planObj.text || "";

  function updateRowColor(){
    const cat=sel.value;
    input.style.color=planColors[cat] || "#111";
  }
  sel.onchange=updateRowColor;
  updateRowColor();

  row.appendChild(top);
  row.appendChild(input);
  planContainer.appendChild(row);
}

/* 添加计划：上一行必须填好 */
addPlanBtn.onclick=()=>{
  const rows=Array.from(planContainer.querySelectorAll(".plan-row"));
  if(rows.length>0){
    const last=rows[rows.length-1];
    const c=last.querySelector(".plan-select").value;
    const t=last.querySelector(".plan-input").value.trim();
    if(!c || !t){
      alert("上一行类别或内容为空，不能再添加新计划");
      return;
    }
  }
  addPlanRow({text:"",category:""});
};

/* 收集 + 保存计划（只更新 plans 字段） */
function collectPlansAndSave(){
  const rows=Array.from(planContainer.querySelectorAll(".plan-row"));
  const newPlans=[];
  rows.forEach(r=>{
    const c=r.querySelector(".plan-select").value;
    const t=r.querySelector(".plan-input").value.trim();
    if(c && t){
      newPlans.push({category:c,text:t});
    }
  });
  plans=newPlans;
  update(dbRef,{ plans });
}

savePlansBtn.onclick=()=>{
  collectPlansAndSave();
  alert("计划已保存并同步");
};
</script>
</body>
</html>
