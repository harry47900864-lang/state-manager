<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>状态量管理（网页版）</title>

<style>
  :root{--accent:#2b6cb0;--danger:#e53e3e}
  body{
    font-family:"Helvetica Neue",Arial;
    margin:0;
    background:linear-gradient(180deg,#f7fafc,#edf2f7);
    color:#111;
  }
  .app{max-width:720px;margin:18px auto;padding:12px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:700}
  .card{
    background:#fff;border-radius:10px;padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px;
  }
  .row{
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 0;border-bottom:1px solid #f1f5f9;
  }
  .row:last-child{border-bottom:0}
  .btn{
    padding:6px 10px;border-radius:6px;border:0;
    background:var(--accent);color:#fff;font-weight:600;cursor:pointer;
  }
  .btn.small{padding:6px 9px;font-size:14px}
  .btn.ghost{
    background:#f7fafc;color:#111;border:1px solid #e2e8f0;
  }
  .stat-label{font-size:16px;font-weight:600}
  .stat-value{font-size:16px;min-width:60px;text-align:center}
  .page{display:none}
  .page.active{display:block}
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,0.4);
    display:flex;align-items:center;justify-content:center;
  }
  .modal .box{
    width:90%;max-width:420px;background:#fff;
    padding:14px;border-radius:10px;
  }
  .option-row{display:flex;gap:10px;margin:8px 0}
  .plan-toggle{
    cursor:pointer;padding:6px 10px;border-radius:8px;
    border:1px dashed #cbd5e1;font-weight:600;
  }
  .history-list{
    max-height:260px;overflow:auto;padding:6px;
    background:#fbfdff;border-radius:6px;border:1px solid #e6eef8;
  }
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{
    background:#2d3748;color:#fff;border-radius:8px;
    padding:8px 10px;border:0;cursor:pointer;
  }
</style>
</head>

<body>
<div class="app">

  <div class="top">
    <div class="title">状态量管理（网页版）</div>
    <div>
      <button id="toPage1" class="btn small">第一页</button>
      <button id="toPage2" class="btn small btn-ghost">第二页</button>
    </div>
  </div>

  <!-- 页 1 -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
          <div id="planStatus" class="plan-toggle">计划未制定</div>
        </div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div id="statsCard" class="card"></div>
    <div class="small-muted" style="text-align:center">
      提示：未制定计划禁止加分（减分正常）
    </div>
  </div>

  <!-- 页 2 -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:18px;font-weight:700">
            胜点：<span id="scoreLabel">0</span>
          </div>
          <div class="small-muted">
            段位 / 境界：<span id="rankAndRealm">黑铁 / 凡人</span>
          </div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div id="highLabel" style="font-weight:700">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">历史记录</div>
        <button id="exportBtn" class="export-btn">导出 JSON</button>
      </div>
      <div id="historyBox" class="history-list"></div>
    </div>
  </div>

</div>

<!-- 弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div id="modalTitle" style="font-weight:700">选择加减</div>
    <div id="optionRow" class="option-row"></div>
    <input id="reasonInput" type="text" placeholder="请输入理由（必填）"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0"/>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="cancelModal" class="btn small btn-ghost">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<script>
/* ======================== 数据 ======================== */
const stats = ["主线","综合技能","身体素质","人际关系"];
let values = {}, logs = [], planMade = false, highest = 0;

function loadState(){
  const s = localStorage.getItem("state_manager_v1");
  if(s){
    const o = JSON.parse(s);
    values = o.values;
    logs = o.logs || [];
    planMade = o.planMade;
    highest = o.highest || 0;
  } else {
    stats.forEach(k=> values[k]=0);
  }
}
function saveState(){
  localStorage.setItem("state_manager_v1", JSON.stringify({
    values, logs, planMade, highest
  }));
}

/* ======================= 段位境界 ======================= */
function rankAndRealm(score){
  if(score<20) return ["黑铁","凡人"];
  if(score<60) return ["青铜Ⅲ","凡人"];
  if(score<100) return ["青铜Ⅱ","凡人"];
  if(score<150) return ["青铜Ⅰ","凡人"];
  if(score<200) return ["白银Ⅲ","化劲"];
  if(score<250) return ["白银Ⅱ","化劲"];
  if(score<300) return ["白银Ⅰ","化劲"];
  if(score<400) return ["黄金Ⅲ","筑基"];
  if(score<500) return ["黄金Ⅱ","筑基"];
  if(score<600) return ["黄金Ⅰ","筑基"];
  if(score<750) return ["铂金Ⅲ","炼虚"];
  if(score<900) return ["铂金Ⅱ","炼虚"];
  if(score<1050) return ["铂金Ⅰ","炼虚"];
  return ["王者","结丹"];
}

/* ======================== 渲染UI ======================== */
function renderStats(){
  const card = document.getElementById("statsCard");
  card.innerHTML="";
  stats.forEach(s=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <div style="display:flex;align-items:center;gap:10px">
        <div class="stat-label">${s}</div>
        <div class="stat-value" id="val_${s}">${values[s]}</div>
      </div>
      <div>
        <button class="btn small" onclick="openModal('${s}',true)">+</button>
        <button class="btn small btn-ghost" onclick="openModal('${s}',false)">-</button>
      </div>
    `;
    card.appendChild(row);
  });
  updateTop();
}

function updateTop(){
  const score = Object.values(values).reduce((a,b)=>a+b,0);
  const [r, realm] = rankAndRealm(score);

  document.getElementById("scoreLabel").textContent = score;
  document.getElementById("rankLabel").textContent = "段位：" + r;
  document.getElementById("rankAndRealm").textContent = r + " / " + realm;

  document.getElementById("highestPreview").textContent = highest;
  document.getElementById("highLabel").textContent = highest;

  document.getElementById("planStatus").textContent =
    planMade ? "计划已制定" : "计划未制定";
  document.getElementById("planStatus").style.color =
    planMade ? "#111" : "var(--danger)";
}

/* ======================== 弹窗逻辑 ======================== */
let modalStat=null, modalAdd=true, chosenAmount=null;

function openModal(stat,isAdd){
  if(isAdd && !planMade){
    alert("当前未制定计划，不能加分。");
    return;
  }
  modalStat = stat;
  modalAdd = isAdd;
  chosenAmount=null;

  document.getElementById("modalTitle").textContent =
    (isAdd? "增加 ":"减少 ") + stat;

  const row=document.getElementById("optionRow");
  row.innerHTML="";
  [1,3,5].forEach(n=>{
    const btn=document.createElement("button");
    btn.className="btn small btn-ghost";
    btn.textContent = (isAdd?"+":"-") + n;
    btn.onclick = (ev)=>{
      chosenAmount = n;
      [...row.children].forEach(b=>b.style.border="1px solid #e2e8f0");
      ev.target.style.border="2px solid var(--accent)";
    };
    row.appendChild(btn);
  });

  document.getElementById("reasonInput").value="";
  document.getElementById("modal").style.display="flex";
}
document.getElementById("cancelModal").onclick=()=>{
  document.getElementById("modal").style.display="none";
};

document.getElementById("confirmModal").onclick=()=>{
  const r = document.getElementById("reasonInput").value.trim();
  if(!chosenAmount || r===""){ alert("请选择数量并填写理由"); return; }
  applyChange(modalStat, modalAdd, chosenAmount, r);
  document.getElementById("modal").style.display="none";
};

/* ======================== 应用加减 ======================== */
function applyChange(stat, isAdd, n, reason){
  const delta = isAdd ? n : -n;
  values[stat] += delta;

  const ts = new Date().toLocaleString();
  logs.unshift({time:ts, stat, delta, reason});

  const score = Object.values(values).reduce((a,b)=>a+b,0);
  if(score>highest) highest = score;

  saveState();
  renderStats();
  renderHistory();
}

/* ======================== 历史记录 ======================== */
function renderHistory(){
  const box=document.getElementById("historyBox");
  box.innerHTML="";
  logs.forEach(x=>{
    const d=document.createElement("div");
    d.style.padding="6px 4px";
    d.style.borderBottom="1px dashed #e5e7eb";
    d.innerHTML=`
      <div style="font-weight:600">${x.time}</div>
      <div>${x.stat}：${x.delta>0?("+"+x.delta):x.delta}</div>
      <div class="small-muted">理由：${x.reason}</div>
    `;
    box.appendChild(d);
  });
}

/* ======================== 导出 JSON ======================== */
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify({values,logs,highest},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="state_manager_data.json";
  a.click();
};

/* ======================== 页面切换 ======================== */
document.getElementById("toPage1").onclick=()=>{
  page1.classList.add("active");
  page2.classList.remove("active");
};
document.getElementById("toPage2").onclick=()=>{
  page2.classList.add("active");
  page1.classList.remove("active");
};

/* ======================== 计划切换 ======================== */
document.getElementById("planStatus").onclick=()=>{
  planMade = !planMade;
  saveState();
  updateTop();
};

/* ======================== 启动 ======================== */
loadState();
renderStats();
renderHistory();
</script>

</body>
</html>
