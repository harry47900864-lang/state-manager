<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>布鲁斯训练营</title>
<style>
  :root{--bg:#0f1720;--card:#ffffff;--accent:#2b6cb0;--danger:#e53e3e}
  body{font-family:"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#f7fafc,#edf2f7);color:#111}
  .app{max-width:720px;margin:18px auto;padding:12px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:700}
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  .row:last-child{border-bottom:0}
  .btn{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;font-weight:600}
  .btn.small{padding:6px 9px;font-size:14px}
  .btn.ghost{background:#f7fafc;color:#111;border:1px solid #e2e8f0}
  .stat-label{font-size:16px;font-weight:600}
  .stat-value{font-size:16px;min-width:60px;text-align:center}
  .pager{display:flex;justify-content:center;margin-top:8px}
  .page{display:none}
  .page.active{display:block}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
  .modal .box{width:90%;max-width:420px;background:#fff;padding:14px;border-radius:10px}
  .option-row{display:flex;gap:8px;margin:8px 0}
  .history-list{max-height:260px;overflow:auto;padding:6px;background:#fbfdff;border-radius:6px;border:1px solid #e6eef8}
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{background:#2d3748;color:#fff;border-radius:8px;padding:8px 10px;border:0}
  .plan-row{display:flex;gap:6px;margin-bottom:8px}
  .plan-input{flex:1;padding:6px;border-radius:6px;border:1px solid #dce3ea}
  .score-input{width:60px;padding:6px;border-radius:6px;border:1px solid #dce3ea;text-align:center}
  .finish-btn{background:#38a169;color:#fff;border:0;border-radius:6px;padding:6px 10px}
  .type-select{padding:6px;border-radius:6px;border:1px solid #dce3ea}
</style>
</head>

<body>
<div class="app">

  <div class="top">
    <div class="title">布鲁斯训练营</div>
    <div id="pageSwitchWrap">
      <button id="toPage1" class="btn small">第一页</button>
      <button id="toPage2" class="btn small btn-ghost">第二页</button>
      <button id="toPagePlan" class="btn small btn-ghost">计划</button>
    </div>
  </div>

  <!-- PAGE 1 : 状态页 -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div class="card" id="statsCard"></div>
    <div style="text-align:center" class="small-muted">
      提示：点击 + 或 - 进行操作。
    </div>
  </div>

  <!-- PAGE 2 : 历史记录 -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:700">
            胜点：<span id="scoreLabel">0</span>
          </div>
          <div class="small-muted">段位/境界：
            <span id="rankAndRealm">黑铁 / 凡人</span>
          </div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div style="font-weight:700" id="highLabel">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">历史记录</div>
        <div><button id="exportBtn" class="export-btn">导出 JSON</button></div>
      </div>
      <div class="history-list" id="historyBox"></div>
    </div>
  </div>

  <!-- PAGE 3 : 计划页 -->
  <div id="pagePlan" class="page">
    <div class="card">
      <div style="font-size:18px;font-weight:700;margin-bottom:8px">计划列表</div>
      <div id="planContainer"></div>
      <button id="addPlanBtn" class="btn small" style="margin-top:10px">添加计划</button>
    </div>
  </div>

</div>
<!-- 选择值 + 理由 弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div style="font-weight:700" id="modalTitle">选择加减</div>
    <div class="option-row" id="optionRow"></div>
    <input id="reasonInput" type="text" placeholder="请输入理由（必填）"
           style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0"/>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
      <button id="cancelModal" class="btn btn-ghost small">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= Firebase 初始化 ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdFS7wHsiQD1Bh_0sOvTvstt4gZvd3u6g",
  authDomain: "state-manager-561b7.firebaseapp.com",
  databaseURL: "https://state-manager-561b7-default-rtdb.firebaseio.com",
  projectId: "state-manager-561b7",
  storageBucket: "state-manager-561b7.appspot.com",
  messagingSenderId: "58381946444",
  appId: "1:58381946444:web:295079a9724fbd3093aee9",
  measurementId: "G-FQ96DM0FMX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "state_manager_v1");

/* ================== 全局数据 ================== */
const stats = ["主线","综合技能","身体素质","人际关系"];
let values = {};
let logs = [];
let highest = 0;
let plans = [];   // 计划数组 [{text, type, score}]


/* ============== 根据数据库实时更新 ============== */
onValue(dbRef, snap => {
  const data = snap.val();
  if (data) {
    values = data.values || {};
    logs = data.logs || [];
    highest = data.highest || 0;
    plans = data.plans || [];
  } else {
    stats.forEach(s => values[s] = 0);
    logs = [];
    highest = 0;
    plans = [];
  }
  renderStats();
  renderHistory();
  renderPlans();
  updateTop();
});


/* ================== 保存到 Firebase ================== */
function saveAll() {
  set(dbRef, { values, logs, highest, plans });
}


/* ================== 渲染状态页 ================== */
function renderStats() {
  const card = document.getElementById("statsCard");
  card.innerHTML = "";

  stats.forEach(s => {
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.alignItems = "center";
    left.style.gap = "10px";

    const label = document.createElement("div");
    label.className = "stat-label";
    label.textContent = s;

    const val = document.createElement("div");
    val.className = "stat-value";
    val.id = "val_" + s;
    val.textContent = values[s] ?? 0;

    left.appendChild(label);
    left.appendChild(val);

    const right = document.createElement("div");
    const addBtn = document.createElement("button");
    addBtn.className = "btn small";
    addBtn.textContent = "+";
    addBtn.onclick = () => openModal(s, true);

    const subBtn = document.createElement("button");
    subBtn.className = "btn small btn-ghost";
    subBtn.textContent = "-";
    subBtn.onclick = () => openModal(s, false);

    right.appendChild(addBtn);
    right.appendChild(subBtn);

    row.appendChild(left);
    row.appendChild(right);

    card.appendChild(row);
  });

  updateTop();
}


/* ================== 更新顶部信息 ================== */
function updateTop() {
  const score = Object.values(values).reduce((a, b) => a + b, 0);
  const rr = rankAndRealm(score);

  document.getElementById("scoreLabel").textContent = score;
  document.getElementById("rankLabel").textContent = "段位：" + rr.rank;
  document.getElementById("rankAndRealm").textContent = rr.rank + " / " + rr.realm;
  document.getElementById("highLabel").textContent = highest;
  document.getElementById("highestPreview").textContent = highest;

  document.querySelectorAll(".stat-value").forEach(el => {
    const id = el.id.replace("val_", "");
    el.textContent = values[id] ?? 0;
  });
}


/* ================== 段位规则 ================== */
function rankAndRealm(score) {
  if (score < 20) return { rank:"黑铁", realm:"凡人" };
  if (score < 60) return { rank:"青铜Ⅲ", realm:"凡人" };
  if (score < 100) return { rank:"青铜Ⅱ", realm:"凡人" };
  if (score < 150) return { rank:"青铜Ⅰ", realm:"凡人" };
  if (score < 200) return { rank:"白银Ⅲ", realm:"化劲" };
  if (score < 250) return { rank:"白银Ⅱ", realm:"化劲" };
  if (score < 300) return { rank:"白银Ⅰ", realm:"化劲" };
  if (score < 400) return { rank:"黄金Ⅲ", realm:"筑基" };
  if (score < 500) return { rank:"黄金Ⅱ", realm:"筑基" };
  if (score < 600) return { rank:"黄金Ⅰ", realm:"筑基" };
  if (score < 750) return { rank:"铂金Ⅲ", realm:"炼虚" };
  if (score < 900) return { rank:"铂金Ⅱ", realm:"炼虚" };
  if (score < 1050) return { rank:"铂金Ⅰ", realm:"炼虚" };
  return { rank:"王者", realm:"结丹" };
}


/* ================== 加减分弹窗 ================== */
let modalStat = null;
let modalAdd = true;
let chosenAmount = null;

function openModal(stat, isAdd) {
  modalStat = stat;
  modalAdd = isAdd;
  chosenAmount = null;

  document.getElementById("modalTitle").textContent =
      (isAdd ? "增加" : "减少") + " - " + stat;

  const row = document.getElementById("optionRow");
  row.innerHTML = "";

  [1, 3, 5].forEach(n => {
    const b = document.createElement("button");
    b.className = "btn small btn-ghost";
    b.textContent = (isAdd ? "+" : "-") + n;
    b.onclick = () => {
      chosenAmount = n;
      [...row.children].forEach(x => x.style.border = "1px solid #e2e8f0");
      b.style.border = "2px solid var(--accent)";
    };
    row.appendChild(b);
  });

  document.getElementById("reasonInput").value = "";
  document.getElementById("modal").style.display = "flex";
}

document.getElementById("cancelModal").onclick = () =>
  document.getElementById("modal").style.display = "none";

document.getElementById("confirmModal").onclick = () => {
  const reason = document.getElementById("reasonInput").value.trim();
  if (!chosenAmount) return alert("请选择数量");
  if (!reason) return alert("理由不能为空");

  applyChange(modalStat, modalAdd, chosenAmount, reason);
  document.getElementById("modal").style.display = "none";
};


/* ================== 实际执行加减分 ================== */
function applyChange(stat, isAdd, amount, reason) {
  const delta = isAdd ? amount : -amount;
  values[stat] += delta;

  const ts = new Date().toISOString().replace("T", " ").slice(0, 19);
  logs.unshift({ time: ts, stat, delta, reason });

  const score = Object.values(values).reduce((a, b) => a + b, 0);
  if (score > highest) highest = score;

  saveAll();
}


/* ================== 历史记录渲染 ================== */
function renderHistory() {
  const box = document.getElementById("historyBox");
  box.innerHTML = "";
  logs.forEach(item => {
    const d = document.createElement("div");
    d.style.padding = "6px 4px";
    d.style.borderBottom = "1px dashed #eef2ff";
    d.innerHTML =
      `<div style="font-weight:600">${item.time}  ${item.stat} ${item.delta>0?('+'+item.delta):item.delta}</div>
       <div class="small-muted">理由：${escapeHtml(item.reason)}</div>`;
    box.appendChild(d);
  });
}
function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}


/* ================== 计划页 ================== */
function renderPlans() {
  const box = document.getElementById("planContainer");
  box.innerHTML = "";

  plans.forEach((p, idx) => {
    const row = document.createElement("div");
    row.className = "plan-row";

    // 类型选择
    const sel = document.createElement("select");
    sel.className = "type-select";
    stats.forEach(s => {
      const o = document.createElement("option");
      o.value = s;
      o.textContent = s;
      if (p.type === s) o.selected = true;
      sel.appendChild(o);
    });
    sel.onchange = () => {
      plans[idx].type = sel.value;
      saveAll();
    };

    // 计划内容
    const inp = document.createElement("input");
    inp.className = "plan-input";
    inp.value = p.text;
    inp.onchange = () => {
      if (!inp.value.trim()) return alert("计划内容不能为空");
      plans[idx].text = inp.value.trim();
      saveAll();
    };

    // 分值输入框
    const score = document.createElement("input");
    score.className = "score-input";
    score.type = "number";
    score.value = p.score ?? "";
    score.placeholder = "分";
    score.onchange = () => {
      let v = parseFloat(score.value);
      if (isNaN(v) || v <= 0 || v > 10) {
        alert("分值必须为 0.1 - 10");
        score.value = p.score ?? "";
        return;
      }
      plans[idx].score = v;
      saveAll();
    };

    // 完成按钮
    const btn = document.createElement("button");
    btn.className = "finish-btn";
    btn.textContent = "完成";
    btn.onclick = () => finishPlan(idx);

    row.appendChild(sel);
    row.appendChild(inp);
    row.appendChild(score);
    row.appendChild(btn);

    box.appendChild(row);
  });
}


/* ================== 完成计划 ================== */
function finishPlan(index) {
  const p = plans[index];
  if (!p.score) return alert("请填写分值");
  if (!p.type) return alert("请选择任务类别");

  // 为对应状态量加分
  values[p.type] += p.score;

  const ts = new Date().toISOString().replace("T", " ").slice(0, 19);
  logs.unshift({
    time: ts,
    stat: p.type,
    delta: "+" + p.score,
    reason: "完成计划：" + p.text
  });

  const scoreTotal = Object.values(values).reduce((a, b) => a + b, 0);
  if (scoreTotal > highest) highest = scoreTotal;

  // 删除计划
  plans.splice(index, 1);
  saveAll();
}


/* ================== 添加计划 ================== */
document.getElementById("addPlanBtn").onclick = () => {
  // 检查上一行是否为空
  if (plans.length > 0) {
    const last = plans[plans.length - 1];
    if (!last.text.trim()) return alert("上一行计划为空，不能继续添加");
  }

  plans.push({ text: "", type: "主线", score: "" });
  saveAll();
};


/* ================== 页面切换 ================== */
function showPage(p) {
  ["page1","page2","pagePlan"].forEach(id => {
    document.getElementById(id).classList.remove("active");
  });
  document.getElementById(p).classList.add("active");

  // 按钮样式更新
  ["toPage1","toPage2","toPagePlan"].forEach(btn=>{
    document.getElementById(btn).classList.remove("btn-ghost");
  });
  document.getElementById(
    p==="page1" ? "toPage1" :
    p==="page2" ? "toPage2" : "toPagePlan"
  ).classList.add("btn-ghost");
}

document.getElementById("toPage1").onclick = () => showPage("page1");
document.getElementById("toPage2").onclick = () => showPage("page2");
document.getElementById("toPagePlan").onclick = () => showPage("pagePlan");


/* ================== 导出 JSON ================== */
document.getElementById("exportBtn").onclick = () => {
  const data = JSON.stringify({ values, logs, highest, plans }, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "state_data.json";
  a.click();
  URL.revokeObjectURL(url);
};

</script>
</body>
</html>
