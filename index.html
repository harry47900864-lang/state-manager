<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>状态量管理（同步版·无计划按钮）</title>
<style>
  :root{--bg:#0f1720;--card:#ffffff;--accent:#2b6cb0;--danger:#e53e3e}
  body{font-family:"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#f7fafc,#edf2f7);color:#111}
  .app{max-width:720px;margin:18px auto;padding:12px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:700}
  .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9}
  .row:last-child{border-bottom:0}
  .btn{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;font-weight:600}
  .btn.small{padding:6px 9px;font-size:14px}
  .btn.ghost{background:#f7fafc;color:#111;border:1px solid #e2e8f0}
  .stat-label{font-size:16px;font-weight:600}
  .stat-value{font-size:16px;min-width:60px;text-align:center}
  .page{display:none}
  .page.active{display:block}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
  .modal .box{width:90%;max-width:420px;background:#fff;padding:14px;border-radius:10px}
  .option-row{display:flex;gap:8px;margin:8px 0}
  .history-list{max-height:260px;overflow:auto;padding:6px;background:#fbfdff;border-radius:6px;border:1px solid #e6eef8}
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{background:#2d3748;color:#fff;border-radius:8px;padding:8px 10px;border:0}
</style>
</head>
<body>

<div class="app">
  <div class="top">
    <div class="title">状态量管理（同步版）</div>
    <div>
      <button id="toPage1" class="btn small">第一页</button>
      <button id="toPage2" class="btn small btn-ghost">第二页</button>
    </div>
  </div>

  <!-- PAGE 1 -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div class="card" id="statsCard"></div>
  </div>

  <!-- PAGE 2 -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:700">胜点：<span id="scoreLabel">0</span></div>
          <div class="small-muted">段位/境界：<span id="rankAndRealm">黑铁 / 凡人</span></div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div id="highLabel" style="font-weight:700">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">历史记录</div>
        <button id="exportBtn" class="export-btn">导出 JSON</button>
      </div>
      <div class="history-list" id="historyBox"></div>
    </div>
  </div>
</div>

<!-- 弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div id="modalTitle" style="font-weight:700">选择加减</div>
    <div id="optionRow" class="option-row"></div>
    <input id="reasonInput" type="text" placeholder="请输入理由（必填）"
           style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0"/>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
      <button id="cancelModal" class="btn btn-ghost small">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<!-- Firebase + 主逻辑 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdFS7wHsiQD1Bh_0sOvTvstt4gZvd3u6g",
  authDomain: "state-manager-561b7.firebaseapp.com",
  databaseURL: "https://state-manager-561b7-default-rtdb.firebaseio.com",
  projectId: "state-manager-561b7",
  storageBucket: "state-manager-561b7.appspot.com",
  messagingSenderId: "58381946444",
  appId: "1:58381946444:web:295079a9724fbd3093aee9",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "state_manager_v1");

// 状态量
const stats = ["主线","综合技能","身体素质","人际关系"];
let values = {};
let logs = [];
let highest = 0;

// 监听数据库变化
onValue(dbRef, snap=>{
  const data = snap.val();
  if(!data){
    stats.forEach(s=>values[s]=0);
    logs=[];
    highest=0;
  }else{
    values=data.values||{};
    logs=data.logs||[];
    highest=data.highest||0;
  }
  renderStats(); renderHistory(); updateTop();
});

// UI 渲染函数
function renderStats(){
  const card=document.getElementById("statsCard");
  card.innerHTML="";
  stats.forEach(s=>{
    const row=document.createElement("div"); row.className="row";
    const left=document.createElement("div"); left.style.display="flex"; left.style.gap="10px"; left.style.alignItems="center";
    const name=document.createElement("div"); name.className="stat-label"; name.textContent=s;
    const val=document.createElement("div"); val.id="val_"+s; val.className="stat-value"; val.textContent=values[s];
    left.appendChild(name); left.appendChild(val);

    const right=document.createElement("div");
    const add=document.createElement("button"); add.className="btn small"; add.textContent="+";
    add.onclick=()=>openModal(s,true);
    const sub=document.createElement("button"); sub.className="btn small btn-ghost"; sub.textContent="-";
    sub.onclick=()=>openModal(s,false);
    right.appendChild(add); right.appendChild(sub);

    row.appendChild(left); row.appendChild(right);
    card.appendChild(row);
  });
}

// 顶部更新
function updateTop(){
  const score = Object.values(values).reduce((a,b)=>a+b,0);
  const rr = rankRealm(score);
  document.getElementById("scoreLabel").textContent=score;
  document.getElementById("rankLabel").textContent="段位："+rr.rank;
  document.getElementById("rankAndRealm").textContent=`${rr.rank} / ${rr.realm}`;
  document.getElementById("highestPreview").textContent=highest;
  document.getElementById("highLabel").textContent=highest;

  Object.keys(values).forEach(s=>{
    const el=document.getElementById("val_"+s);
    if(el) el.textContent=values[s];
  });
}

// 段位判断
function rankRealm(x){
  if(x<20) return {rank:"黑铁",realm:"凡人"};
  if(x<60) return {rank:"青铜Ⅲ",realm:"凡人"};
  if(x<100) return {rank:"青铜Ⅱ",realm:"凡人"};
  if(x<150) return {rank:"青铜Ⅰ",realm:"凡人"};
  if(x<200) return {rank:"白银Ⅲ",realm:"化劲"};
  if(x<250) return {rank:"白银Ⅱ",realm:"化劲"};
  if(x<300) return {rank:"白银Ⅰ",realm:"化劲"};
  if(x<400) return {rank:"黄金Ⅲ",realm:"筑基"};
  if(x<500) return {rank:"黄金Ⅱ",realm:"筑基"};
  if(x<600) return {rank:"黄金Ⅰ",realm:"筑基"};
  if(x<750) return {rank:"铂金Ⅲ",realm:"炼虚"};
  if(x<900) return {rank:"铂金Ⅱ",realm:"炼虚"};
  if(x<1050)return {rank:"铂金Ⅰ",realm:"炼虚"};
  return {rank:"王者",realm:"结丹"};
}

// 打开弹窗
let modalStat=null,modalAdd=true,modalNum=null;
function openModal(s,isAdd){
  modalStat=s; modalAdd=isAdd; modalNum=null;
  document.getElementById("modalTitle").textContent=(isAdd?"增加":"减少")+" - "+s;
  const row=document.getElementById("optionRow"); row.innerHTML="";
  [1,3,5].forEach(n=>{
    const b=document.createElement("button");
    b.className="btn small btn-ghost";
    b.textContent=(isAdd?"+":"-")+n;
    b.onclick=()=>{modalNum=n; [...row.children].forEach(x=>x.style.border="1px solid #ccc"); b.style.border="2px solid var(--accent)";}
    row.appendChild(b);
  });
  document.getElementById("reasonInput").value="";
  document.getElementById("modal").style.display="flex";
}

// 取消
document.getElementById("cancelModal").onclick=()=>{
  document.getElementById("modal").style.display="none";
};

// 确认提交
document.getElementById("confirmModal").onclick=()=>{
  const reason=document.getElementById("reasonInput").value.trim();
  if(!modalNum||!reason){alert("需要选择数量并填写理由");return;}
  const delta = modalAdd?modalNum:-modalNum;
  values[modalStat]+=delta;

  const ts=new Date().toISOString().replace("T"," ").slice(0,19);
  logs.push({time:ts,stat:modalStat,delta,reason});

  const score=Object.values(values).reduce((a,b)=>a+b,0);
  if(score>highest) highest=score;

  set(dbRef,{values,logs,highest});
  document.getElementById("modal").style.display="none";
};

// 历史渲染
function renderHistory(){
  const box=document.getElementById("historyBox");
  box.innerHTML="";
  logs.slice().reverse().forEach(i=>{
    const d=document.createElement("div");
    d.style.padding="6px"; d.style.borderBottom="1px dashed #eef2ff";
    d.innerHTML=`<div style="font-weight:600">${i.time} ${i.stat} ${i.delta>0?("+"+i.delta):i.delta}</div>
                 <div class="small-muted">理由：${i.reason}</div>`;
    box.appendChild(d);
  });
}

// 导出
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify({values,logs,highest},null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="state_history.json";
  a.click();
};

// 页面切换
document.getElementById("toPage1").onclick=()=>{
  page1.classList.add("active"); page2.classList.remove("active");
  toPage1.classList.add("btn-ghost"); toPage2.classList.remove("btn-ghost");
};
document.getElementById("toPage2").onclick=()=>{
  page2.classList.add("active"); page1.classList.remove("active");
  toPage2.classList.add("btn-ghost"); toPage1.classList.remove("btn-ghost");
};
</script>

</body>
</html>
