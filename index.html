<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>布鲁斯训练营</title>

<style>
  :root{--bg:#0f1720;--card:#ffffff;--accent:#2b6cb0;--danger:#e53e3e}
  body{font-family:"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#f7fafc,#edf2f7);color:#111}

  .app{max-width:720px;margin:18px auto;padding:12px}
  .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:700}

  .card{background:#fff;border-radius:10px;padding:12px;
        box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}

  .row{display:flex;align-items:center;justify-content:space-between;
       padding:8px 0;border-bottom:1px solid #f1f5f9}
  .row:last-child{border-bottom:0}

  .btn{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;font-weight:600}
  .btn.small{padding:6px 9px;font-size:14px}
  .btn.ghost{background:#f7fafc;color:#111;border:1px solid #e2e8f0}

  .stat-label{font-size:16px;font-weight:600}
  .stat-value{font-size:16px;min-width:60px;text-align:center}

  .page{display:none}
  .page.active{display:block}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);
         display:flex;align-items:center;justify-content:center}
  .modal .box{width:90%;max-width:420px;background:#fff;padding:14px;border-radius:10px}

  .option-row{display:flex;gap:8px;margin:8px 0}
  .history-list{max-height:260px;overflow:auto;padding:6px;background:#fbfdff;
                border-radius:6px;border:1px solid #e6eef8}
  .small-muted{font-size:13px;color:#64748b}
  .export-btn{background:#2d3748;color:#fff;border-radius:8px;padding:8px 10px;border:0}

  .plan-row{display:flex;gap:6px;margin-bottom:8px;align-items:center}
  .plan-input{flex:1;padding:6px;border-radius:6px;border:1px solid #dce3ea;font-size:15px}
  .score-input{width:60px;padding:6px;border-radius:6px;border:1px solid #dce3ea;text-align:center}
  .finish-btn{background:#38a169;color:#fff;border:0;border-radius:6px;padding:6px 10px}
  .type-select{padding:6px;border-radius:6px;border:1px solid #dce3ea}
</style>
</head>

<body>
<div class="app">

  <!-- 顶部导航 -->
  <div class="top">
    <div class="title">布鲁斯训练营</div>
    <div id="pageSwitchWrap">
      <button id="toPage1" class="btn small">状态</button>
      <button id="toPage2" class="btn small btn-ghost">历史</button>
      <button id="toPagePlan" class="btn small btn-ghost">计划</button>
    </div>
  </div>

  <!-- PAGE 1（状态量） -->
  <div id="page1" class="page active">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div id="rankLabel" style="font-weight:700">段位：黑铁</div>
        <div class="small-muted">历史最高：<span id="highestPreview">0</span></div>
      </div>
    </div>

    <div class="card" id="statsCard"></div>
  </div>

  <!-- PAGE 2（历史记录） -->
  <div id="page2" class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:700">
            胜点：<span id="scoreLabel">0</span>
          </div>
          <div class="small-muted">段位/境界：<span id="rankAndRealm">黑铁 / 凡人</span></div>
        </div>
        <div style="text-align:right">
          <div class="small-muted">历史最高</div>
          <div style="font-weight:700" id="highLabel">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">历史记录</div>
        <button id="exportBtn" class="export-btn">导出 JSON</button>
      </div>
      <div id="historyBox" class="history-list"></div>
    </div>
  </div>

  <!-- PAGE 3（计划页面） -->
  <div id="pagePlan" class="page">
    <div class="card">
      <div style="font-size:18px;font-weight:700;margin-bottom:10px">计划列表</div>

      <div id="planContainer"></div>

      <button id="addPlanBtn" class="btn small" style="margin-top:10px">
        添加计划
      </button>
    </div>
  </div>

</div>

<!-- 加减弹窗 -->
<div id="modal" class="modal" style="display:none">
  <div class="box">
    <div style="font-weight:700" id="modalTitle">选择加减</div>

    <div class="option-row" id="optionRow"></div>

    <input id="reasonInput" type="text"
      placeholder="请输入理由（必填）"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0"/>

    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px">
      <button id="cancelModal" class="btn btn-ghost small">取消</button>
      <button id="confirmModal" class="btn small">确认</button>
    </div>
  </div>
</div>

<!-- JS 逻辑（含输入法修复） -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdFS7wHsiQD1Bh_0sOvTvstt4gZvd3u6g",
  authDomain: "state-manager-561b7.firebaseapp.com",
  databaseURL: "https://state-manager-561b7-default-rtdb.firebaseio.com",
  projectId: "state-manager-561b7",
  storageBucket: "state-manager-561b7.appspot.com",
  messagingSenderId: "58381946444",
  appId: "1:58381946444:web:295079a9724fbd3093aee9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "state_manager_FINAL");

const stats = ["主线","综合技能","身体素质","人际关系"];
const typeColor = {
  "主线":"#2b6cb0",
  "综合技能":"#38a169",
  "身体素质":"#e53e3e",
  "人际关系":"#805ad5"
};

let values = {};
let logs = [];
let highest = 0;
let plans = [];

onValue(dbRef, snapshot=>{
  const data = snapshot.val();
  if(data){
    values = data.values || {};
    logs = data.logs || [];
    highest = data.highest || 0;
    plans = data.plans || [];
  }else{
    stats.forEach(s => values[s]=0);
    logs=[];
    highest=0;
    plans=[];
  }
  renderStats();
  renderHistory();
  renderPlanList();
  updateTop();
});

function saveAll(){
  set(dbRef, {values, logs, highest, plans});
}

/* ---------- 页面切换 ---------- */
document.getElementById("toPage1").onclick=()=>switchPage("page1");
document.getElementById("toPage2").onclick=()=>switchPage("page2");
document.getElementById("toPagePlan").onclick=()=>switchPage("pagePlan");

function switchPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ---------- 排位规则 ---------- */
function rankAndRealm(score){
  let rank,realm;
  if(score<20){rank="黑铁";realm="凡人";}
  else if(score<60){rank="青铜Ⅲ";realm="凡人";}
  else if(score<100){rank="青铜Ⅱ";realm="凡人";}
  else if(score<150){rank="青铜Ⅰ";realm="凡人";}
  else if(score<200){rank="白银Ⅲ";realm="化劲";}
  else if(score<250){rank="白银Ⅱ";realm="化劲";}
  else if(score<300){rank="白银Ⅰ";realm="化劲";}
  else if(score<400){rank="黄金Ⅲ";realm="筑基";}
  else if(score<500){rank="黄金Ⅱ";realm="筑基";}
  else if(score<600){rank="黄金Ⅰ";realm="筑基";}
  else if(score<750){rank="铂金Ⅲ";realm="炼虚";}
  else if(score<900){rank="铂金Ⅱ";realm="炼虚";}
  else if(score<1050){rank="铂金Ⅰ";realm="炼虚";}
  else{rank="王者";realm="结丹";}
  return {rank,realm};
}

/* ---------- 状态量渲染 ---------- */
function renderStats(){
  const card = document.getElementById("statsCard");
  card.innerHTML="";

  stats.forEach(s=>{
    const row = document.createElement("div");
    row.className="row";

    const left=document.createElement("div");
    left.style.display="flex";
    left.style.gap="10px";

    const label=document.createElement("div");
    label.className="stat-label";
    label.textContent=s;

    const val=document.createElement("div");
    val.className="stat-value";
    val.id="val_"+s;
    val.textContent=values[s];

    left.appendChild(label);
    left.appendChild(val);

    const right=document.createElement("div");
    const add=document.createElement("button");
    add.className="btn small"; add.textContent="+";
    add.onclick=()=>openModal(s,true);

    const sub=document.createElement("button");
    sub.className="btn small btn-ghost"; sub.textContent="-";
    sub.onclick=()=>openModal(s,false);

    right.appendChild(add);
    right.appendChild(sub);

    row.appendChild(left);
    row.appendChild(right);
    card.appendChild(row);
  });

  updateTop();
}

/* ---------- 更新顶部 ---------- */
function updateTop(){
  const score = Object.values(values).reduce((a,b)=>a+b,0);
  const rr = rankAndRealm(score);

  document.getElementById("scoreLabel").textContent=score;
  document.getElementById("rankLabel").textContent="段位："+rr.rank;
  document.getElementById("rankAndRealm").textContent=rr.rank+" / "+rr.realm;
  document.getElementById("highLabel").textContent=highest;
  document.getElementById("highestPreview").textContent=highest;
}

/* ---------- 加减弹窗 ---------- */
let modalStat=null, modalAdd=true, chosen=null;

function openModal(stat,isAdd){
  modalStat=stat;
  modalAdd=isAdd;
  chosen=null;

  document.getElementById("modalTitle").textContent=(isAdd?"增加 - ":"减少 - ")+stat;

  const option=document.getElementById("optionRow");
  option.innerHTML="";

  [1,3,5].forEach(n=>{
    const b=document.createElement("button");
    b.className="btn small btn-ghost";
    b.textContent=(isAdd?"+":"-")+n;

    b.onclick=()=>{
      chosen=n;
      [...option.children].forEach(bb=>bb.style.border="1px solid #e2e8f0");
      b.style.border="2px solid var(--accent)";
    };

    option.appendChild(b);
  });

  document.getElementById("reasonInput").value="";
  document.getElementById("modal").style.display="flex";
}

document.getElementById("cancelModal").onclick=()=>{
  document.getElementById("modal").style.display="none";
};

document.getElementById("confirmModal").onclick=()=>{
  const reason=document.getElementById("reasonInput").value.trim();
  if(!chosen || !reason){
    alert("请选择数量并填写理由");
    return;
  }
  const delta = modalAdd ? chosen : -chosen;
  values[modalStat]+=delta;

  const ts=new Date().toISOString().replace("T"," ").slice(0,19);
  logs.push({time:ts,stat:modalStat,delta,reason});

  const score=Object.values(values).reduce((a,b)=>a+b,0);
  if(score>highest) highest=score;

  saveAll();
  document.getElementById("modal").style.display="none";
};

/* ---------- 历史记录 ---------- */
function renderHistory(){
  const box=document.getElementById("historyBox");
  box.innerHTML="";

  logs.slice().reverse().forEach(item=>{
    const d=document.createElement("div");
    d.style.padding="6px 4px";
    d.style.borderBottom="1px dashed #e4e7ef";
    d.innerHTML = `
      <div style="font-weight:600">
        ${item.time}　${item.stat} ${item.delta>0?("+"+item.delta):item.delta}
      </div>
      <div class="small-muted">理由：${item.reason}</div>
    `;
    box.appendChild(d);
  });
}

/* ---------- 计划页面：输入法修复（关键） ---------- */
function attachIMEFix(input){
  let composing=false;

  input.addEventListener("compositionstart",()=>composing=true);
  input.addEventListener("compositionend",()=>{
    composing=false;
    input.dispatchEvent(new Event("input"));
  });

  input.addEventListener("input",()=>{
    if(composing) return; // 解决中文输入卡断
  });
}

/* ---------- 渲染计划 ---------- */
function renderPlanList(){
  const box=document.getElementById("planContainer");
  box.innerHTML="";

  plans.forEach((p,idx)=>{
    const row=document.createElement("div");
    row.className="plan-row";
    row.style.color=typeColor[p.type];

    const sel=document.createElement("select");
    sel.className="type-select";
    stats.forEach(t=>{
      const opt=document.createElement("option");
      opt.value=t; opt.textContent=t;
      if(t===p.type) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.onchange=()=>{
      plans[idx].type=sel.value;
      row.style.color=typeColor[sel.value];
      saveAll();
    };

    const inp=document.createElement("input");
    inp.className="plan-input";
    inp.value=p.text;

    attachIMEFix(inp);

    inp.addEventListener("input",()=>{
      plans[idx].text=inp.value;
      saveAll();
    });

    const score=document.createElement("input");
    score.className="score-input";
    score.type="number";
    score.value=p.score;
    score.min=0; score.max=10;

    score.addEventListener("input",()=>{
      let v=Number(score.value);
      if(v>10) v=10;
      if(v<0) v=0;
      plans[idx].score=v;
      score.value=v;
      saveAll();
    });

    const done=document.createElement("button");
    done.className="finish-btn";
    done.textContent="完成";
    done.onclick=()=>finishPlan(idx);

    row.appendChild(sel);
    row.appendChild(inp);
    row.appendChild(score);
    row.appendChild(done);

    box.appendChild(row);
  });
}

/* ---------- 完成计划 ---------- */
function finishPlan(idx){
  const p=plans[idx];
  if(!p.text.trim()) return;

  const stat=p.type;
  const add=Number(p.score)||0;

  values[stat]+=add;

  const ts=new Date().toISOString().replace("T"," ").slice(0,19);
  logs.push({
    time:ts,
    stat,
    delta:add,
    reason:"完成计划：" + p.text
  });

  plans.splice(idx,1);

  const score=Object.values(values).reduce((a,b)=>a+b,0);
  if(score>highest) highest=score;

  saveAll();
}

/* ---------- 添加计划 ---------- */
document.getElementById("addPlanBtn").onclick=()=>{
  if(plans.length>0 && !plans[plans.length-1].text.trim()){
    alert("上一行计划为空，请先填写完。");
    return;
  }

  plans.push({text:"",type:"主线",score:1});
  saveAll();
};

/* ---------- 导出 JSON ---------- */
document.getElementById("exportBtn").onclick=()=>{
  const blob=new Blob(
    [JSON.stringify({values,logs,highest,plans},null,2)],
    {type:"application/json"}
  );
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="state_history.json";
  a.click();
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
